name: Deploy SAP CAP Node.js App to Azure Web App - ztproducts

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy: # Simplificamos a un solo job para reducir la complejidad
    runs-on: ubuntu-latest
    
    # PERMISOS: Necesarios para el OIDC Azure Login
    permissions:
      id-token: write 
      contents: read 

    steps:
      - uses: actions/checkout@v4
        name: 1. Descargar código

      - name: 2. Set up Node.js version 20
        uses: actions/setup-node@v3
        with:
          node-version: '20.x' # Usamos 20.x para mayor compatibilidad con CAP

      # 3. INSTALACIÓN DE DEPENDENCIAS (Solo npm install)
      - name: 3. Install dependencies
        run: npm install
        # CRUCIAL: Eliminamos 'npm run build' y 'npm run test'. 
        # Azure ejecutará 'npm start' (cds run) al inicio.

      # 4. INICIO DE SESIÓN EN AZURE (usando el Service Principal)
      # Nota: Debes reemplazar los nombres secretos con los que creaste.
      - name: 4. Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }} # Reemplaza por tu nombre de secreto
          tenant-id: ${{ secrets.AZURE_TENANT_ID }} # Reemplaza por tu nombre de secreto
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }} # Reemplaza por tu nombre de secreto
          
      # 5. DESPLIEGUE A AZURE WEB APP
      - name: '5. Deploy to Azure Web App'
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'ztproducts'
          slot-name: 'Production'
          package: .
          
      - name: 6. Logout from Azure
        run: |
          az logout